// FUSIÓN PREMIUM: Diseño empresarial + animaciones fluidas + resúmenes integrados
// - Semanas MANUALES: índice real (1..N) vía WeeksNav, no ISO del año
// - Header muestra temporada_label y bodega_label desde backend (context)
// - Botones Iniciar/Finalizar conectados a servicios startWeek/finishWeek
// - WeekSwitcher: deshabilitado si no hay semanas; prev/next bloqueados según NAV
// - URL sincronizada con ?isoSemana=YYYY-Www (solo etiqueta cuando hay semanas)
// - Refetch sutil post-acciones para Summary/Queues/Alerts

import React, { useCallback, useEffect, useMemo, useState } from "react";
import {
  Box,
  Paper,
  Typography,
  Chip,
  Alert,
  AlertTitle,
  Tooltip,
  IconButton,
  Button,
  Divider,
  alpha,
  useTheme,
  CircularProgress,
} from "@mui/material";
import { useDispatch } from "react-redux";
import { useNavigate, useSearchParams } from "react-router-dom";
import { motion, AnimatePresence } from "framer-motion";

// Icons
import RefreshIcon from "@mui/icons-material/Refresh";
import PlayArrowIcon from "@mui/icons-material/PlayArrow";
import StopIcon from "@mui/icons-material/Stop";
import AssessmentIcon from "@mui/icons-material/Assessment";
import WarehouseIcon from "@mui/icons-material/Warehouse";
import CalendarTodayIcon from "@mui/icons-material/CalendarToday";
import InventoryIcon from "@mui/icons-material/Inventory";
import LocalShippingIcon from "@mui/icons-material/LocalShipping";
import TrendingUpIcon from "@mui/icons-material/TrendingUp";

import { useTableroBodega } from "../hooks/useTableroBodega";
import KpiCards from "../components/tablero/KpiCards";
import WeekSwitcher from "../components/tablero/WeekSwitcher";
import QuickActions from "../components/tablero/QuickActions";

// Resúmenes integrados
import ResumenRecepciones from "../components/tablero/ResumenRecepciones";
import ResumenInventarios from "../components/tablero/ResumenInventarios";
import ResumenLogistica from "../components/tablero/ResumenLogistica";
import type { QueueRowUI } from "../hooks/useTableroBodega";

import { setBreadcrumbs } from "../../../global/store/breadcrumbsSlice";
import { formatDateISO, parseLocalDateStrict } from "../../../global/utils/date";

// Servicios semana (backend)
import { getWeekCurrent, startWeek, finishWeek } from "../services/tableroBodegaService";
import type { WeeksNavResponse, WeekCurrentResponse } from "../types/tableroBodegaTypes";

// ─────────────────────────────────────────────────────────────────────────────
// Animaciones
const pageTransition = {
  initial: { opacity: 0, y: 8, scale: 0.99 },
  animate: {
    opacity: 1,
    y: 0,
    scale: 1,
    transition: { duration: 0.35, ease: [0.22, 1, 0.36, 1] },
  },
  exit: {
    opacity: 0,
    y: -8,
    scale: 0.99,
    transition: { duration: 0.25, ease: "easeIn" },
  },
};

const sectionTransition = {
  initial: { opacity: 0, x: 14 },
  animate: {
    opacity: 1,
    x: 0,
    transition: { duration: 0.3, ease: [0.25, 0.46, 0.45, 0.94] },
  },
};

const staggerChildren = {
  animate: {
    transition: { staggerChildren: 0.08 },
  },
};

// ─────────────────────────────────────────────────────────────────────────────
// Utilidades ISO WEEK (solo etiqueta visual cuando hay semanas)
function pad2(n: number) {
  return n < 10 ? `0${n}` : String(n);
}
function getISODay(d: Date) {
  const day = d.getDay();
  return day === 0 ? 7 : day;
}
function getISOWeekYear(d: Date) {
  const date = new Date(d.getTime());
  date.setHours(0, 0, 0, 0);
  const thursday = new Date(date.getTime());
  thursday.setDate(date.getDate() + (4 - getISODay(date)));
  return thursday.getFullYear();
}
function getISOWeek(d: Date) {
  const date = new Date(d.getTime());
  date.setHours(0, 0, 0, 0);
  const thursday = new Date(date.getTime());
  thursday.setDate(date.getDate() + (4 - getISODay(date)));
  const yearStart = new Date(thursday.getFullYear(), 0, 1);
  const week = Math.floor(((thursday.getTime() - yearStart.getTime()) / 86400000 + getISODay(yearStart) + 3) / 7);
  return week;
}
function dateToIsoKey(d: Date) {
  const year = getISOWeekYear(d);
  const week = getISOWeek(d);
  return `${year}-W${pad2(week)}`;
}
function isoWeekToMonday(year: number, week: number) {
  const jan4 = new Date(year, 0, 4);
  const jan4ISODow = getISODay(jan4);
  const mondayWeek1 = new Date(jan4);
  mondayWeek1.setDate(jan4.getDate() - (jan4ISODow - 1));
  const mondayTarget = new Date(mondayWeek1);
  mondayTarget.setDate(mondayWeek1.getDate() + (week - 1) * 7);
  return mondayTarget;
}
function isoKeyToRange(isoKey: string) {
  const m = isoKey.match(/^(\d{4})-W(\d{2})$/);
  if (!m) return null;
  const year = Number(m[1]);
  const week = Number(m[2]);
  const monday = isoWeekToMonday(year, week);
  const sunday = new Date(monday);
  sunday.setDate(monday.getDate() + 6);
  return { from: formatDateISO(monday), to: formatDateISO(sunday) };
}
function prettyRange(fromISO: string, toISO: string) {
  const from = parseLocalDateStrict(fromISO);
  const to = parseLocalDateStrict(toISO);
  const fmt = (d: Date) =>
    d.toLocaleDateString(undefined, {
      day: "2-digit",
      month: "short",
      year: d.getFullYear() !== new Date().getFullYear() ? "numeric" : undefined,
    });
  return `${fmt(from)} – ${fmt(to)}`;
}
// Preservar query params
function withPreservedParams(href: string, preserveKeys: string[] = ["temporada", "isoSemana", "bodega"]) {
  const current = new URLSearchParams(window.location.search);
  const url = new URL(href, window.location.origin);
  preserveKeys.forEach((k) => {
    if (current.has(k) && !url.searchParams.has(k)) {
      url.searchParams.set(k, current.get(k)!);
    }
  });
  return url.pathname + (url.searchParams.toString() ? `?${url.searchParams.toString()}` : "");
}

// ─────────────────────────────────────────────────────────────────────────────
// Componente principal
const TableroBodegaPage: React.FC = () => {
  const theme = useTheme();
  const dispatch = useDispatch();
  const navigate = useNavigate();
  const [sp, setSp] = useSearchParams();

  const temporadaParam = sp.get("temporada");
  const temporadaId = Number(temporadaParam);
  const bodegaParam = sp.get("bodega");
  const bodegaId = bodegaParam ? Number(bodegaParam) : undefined;

  // Guards: temporada y bodega obligatorias en el flujo
  useEffect(() => {
    if (!temporadaParam || Number.isNaN(temporadaId) || temporadaId <= 0) {
      navigate("/bodega", { replace: true });
    }
  }, [temporadaParam, temporadaId, navigate]);

  useEffect(() => {
    if (!bodegaParam || Number.isNaN(bodegaId as number) || (bodegaId ?? 0) <= 0) {
      navigate("/bodega", { replace: true });
    }
  }, [bodegaParam, bodegaId, navigate]);

  // Hook maestro
  const hookAny = useTableroBodega({ bodegaId: bodegaId!, temporadaId }) as any;

  const {
    kpiCards,
    isLoadingSummary,
    errorSummary,
    refetchSummary,
    filters,
    onApplyFilters,

    // Semana/Nav expuesto por el hook
    weekNav,
    refetchAll,

    // Para refetch sutil tras iniciar/cerrar
    markForRefetch,
    applyMarkedRefetch,
  } = hookAny;

  // Bandera central: ¿hay semanas creadas?
  const hasWeeks: boolean = !!weekNav?.hasWeeks;

  // ISO semana controlada por URL (solo etiqueta visual/navegación cuando hay semanas)
  const [isoSemana, setIsoSemana] = useState<string | null>(() => sp.get("isoSemana"));

  // Estado: semana activa actual en backend
  const [weekState, setWeekState] = useState<WeekCurrentResponse | null>(null);
  // Estado UI de acciones
  const [busyStart, setBusyStart] = useState(false);
  const [busyFinish, setBusyFinish] = useState(false);
  const [actionError, setActionError] = useState<string | null>(null);

  // Seed inicial de isoSemana SOLO si hay semanas
  useEffect(() => {
    if (!hasWeeks) {
      // limpiamos isoSemana de la URL si estaba
      if (sp.get("isoSemana")) {
        const next = new URLSearchParams(sp);
        next.delete("isoSemana");
        setSp(next, { replace: true });
      }
      setIsoSemana(null);
      return;
    }
    if (!isoSemana) {
      const baseISO = filters?.fecha_desde || filters?.fecha_hasta || formatDateISO(new Date());
      const base = parseLocalDateStrict(baseISO);
      const key = dateToIsoKey(base);
      setIsoSemana(key);
      const next = new URLSearchParams(sp);
      next.set("isoSemana", key);
      setSp(next, { replace: true });
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [hasWeeks, isoSemana, filters?.fecha_desde, filters?.fecha_hasta]);

  // Traer estado de semana activa (para habilitar/deshabilitar acciones)
  const refetchWeekState = useCallback(async () => {
    if (!bodegaId || !temporadaId) return;
    try {
      const s = await getWeekCurrent(temporadaId, bodegaId);
      setWeekState(s);
    } catch {
      // silencioso
    }
  }, [bodegaId, temporadaId]);

  useEffect(() => {
    refetchWeekState();
  }, [refetchWeekState]);

  // Aplicar filtros cuando cambia isoSemana (solo si hay semanas)
  useEffect(() => {
    if (!hasWeeks || !isoSemana) return;
    const range = isoKeyToRange(isoSemana);
    if (!range) return;
    onApplyFilters?.({
      fecha_desde: range.from,
      fecha_hasta: range.to,
      isoSemana,
    });
  }, [hasWeeks, isoSemana, onApplyFilters]);

  // Pretty range
  const rangoPretty = useMemo(() => {
    if (!filters?.fecha_desde || !filters?.fecha_hasta) return "";
    return prettyRange(filters.fecha_desde, filters.fecha_hasta);
  }, [filters?.fecha_desde, filters?.fecha_hasta]);

  // Semana índice REAL (1..N) desde backend
  const semanaIndex = weekNav?.indice ?? null;

  // Etiquetas desde backend con fallback
  const temporadaChipLabel = useMemo(
    () => `Temporada ${weekNav?.context?.temporada_label ?? temporadaId}`,
    [weekNav?.context?.temporada_label, temporadaId]
  );
  const bodegaCrumbLabel = useMemo(
    () => `Bodegas — ${weekNav?.context?.bodega_label ?? `#${bodegaId ?? "-"}`}`,
    [weekNav?.context?.bodega_label, bodegaId]
  );

  // Breadcrumbs con labels correctos (omitimos “Semana …” cuando no hay semanas)
  useEffect(() => {
    const crumbs = [
      { label: bodegaCrumbLabel, path: "/bodega" },
      {
        label: temporadaChipLabel,
        path: `/bodega/${bodegaId ?? ""}/temporadas${bodegaId ? `?temporada=${temporadaId}` : ""}`,
      },
    ];
    if (hasWeeks) {
      crumbs.push({ label: `Semana ${semanaIndex ?? "--"}`, path: "" });
    }
    dispatch(setBreadcrumbs(crumbs));
  }, [dispatch, temporadaId, bodegaId, semanaIndex, temporadaChipLabel, bodegaCrumbLabel, hasWeeks]);

  // WeekSwitcher handler (ajusta etiqueta y rango). Si no hay semanas, ignoramos.
  const handleWeekChange = useCallback(
    (range: { from?: string; to?: string; isoSemana?: string | null }) => {
      if (!hasWeeks) return;
      if (!range.from || !range.to) return;
      const key = range.isoSemana || dateToIsoKey(parseLocalDateStrict(range.from));
      setIsoSemana(key);
      const next = new URLSearchParams(sp);
      next.set("isoSemana", key);
      setSp(next, { replace: false });
      onApplyFilters?.({ fecha_desde: range.from, fecha_hasta: range.to, isoSemana: key });
    },
    [hasWeeks, onApplyFilters, sp, setSp]
  );

  // Navegación preservando query relevantes
  const goto = useCallback(
    (href: string) => {
      navigate(withPreservedParams(href, ["temporada", "isoSemana", "bodega"]));
    },
    [navigate]
  );

  // Valor actual para WeekSwitcher
  const weekValue = useMemo(() => {
    if (!hasWeeks) {
      // sin semanas: deshabilitamos switcher y no mostramos rango
      const today = formatDateISO(new Date());
      return { from: today, to: today };
    }
    const fallback = isoSemana ? isoKeyToRange(isoSemana) : null;
    const from = filters?.fecha_desde || fallback?.from || formatDateISO(new Date());
    const to = filters?.fecha_hasta || fallback?.to || formatDateISO(new Date());
    return { from, to };
  }, [hasWeeks, filters?.fecha_desde, filters?.fecha_hasta, isoSemana]);

  // Derivar estado del switcher y navegación
  const disableSwitcher = !hasWeeks;
  const disablePrev = !hasWeeks || !(weekNav?.hasPrev ?? false);
  const disableNext = !hasWeeks || !(weekNav?.hasNext ?? false);

  // Derivar si hay semana abierta y si ya puede cerrarse (7 días completos)
  const hasActiveOpenWeek = useMemo(() => {
    const w = weekState?.active_week;
    return !!(w && w.fecha_fin == null);
  }, [weekState]);

  const canFinish = useMemo(() => {
    if (!hasActiveOpenWeek) return false;
    const to = (weekState as any)?.active_week?.rango_inferido?.to as string | undefined; // YYYY-MM-DD
    if (!to) return false;
    const todayISO = formatDateISO(new Date());
    return todayISO >= to;
  }, [hasActiveOpenWeek, weekState]);

  // ────────────────────────────────────────────────────────────────────────────
  // Acciones: Iniciar / Finalizar (con backend)
  const handleStart = useCallback(async () => {
    setActionError(null);
    if (!bodegaId || !temporadaId) return;
    try {
      setBusyStart(true);
      const from = weekValue.from;
      await startWeek({ bodega: bodegaId, temporada: temporadaId, fecha_desde: from });

      await refetchWeekState();

      // Refetch de todo (incluye weeksNav interno del hook)
      await refetchAll?.();

      // Reposicionar isoSemana si ahora existen semanas
      const base = parseLocalDateStrict(from);
      const key = dateToIsoKey(base);
      setIsoSemana(key);
      const next = new URLSearchParams(sp);
      next.set("isoSemana", key);
      setSp(next, { replace: true });

      // Refetch sutil de tarjetas/colas
      markForRefetch?.("summary");
      markForRefetch?.("recepciones");
      markForRefetch?.("inventarios");
      markForRefetch?.("despachos");
      applyMarkedRefetch?.();
    } catch (e: any) {
      setActionError(e?.message || "No se pudo iniciar la semana.");
    } finally {
      setBusyStart(false);
    }
  }, [bodegaId, temporadaId, weekValue.from, sp, setSp, markForRefetch, applyMarkedRefetch, refetchAll, refetchWeekState]);

  const handleFinish = useCallback(async () => {
    setActionError(null);
    if (!bodegaId || !temporadaId) return;
    try {
      setBusyFinish(true);
      const to = weekValue.to;
      await finishWeek({ bodega: bodegaId, temporada: temporadaId, fecha_hasta: to });

      await refetchWeekState();
      await refetchAll?.();

      // Refetch sutil de tarjetas/colas
      markForRefetch?.("summary");
      markForRefetch?.("recepciones");
      markForRefetch?.("inventarios");
      markForRefetch?.("despachos");
      applyMarkedRefetch?.();
    } catch (e: any) {
      setActionError(e?.message || "No se pudo finalizar la semana.");
    } finally {
      setBusyFinish(false);
    }
  }, [bodegaId, temporadaId, weekValue.to, markForRefetch, applyMarkedRefetch, refetchAll, refetchWeekState]);

  // ────────────────────────────────────────────────────────────────────────────
  // Datos para resúmenes
  const emptyMeta = { page: 1, page_size: 10, total: 0 };

  const recepRows: QueueRowUI[] = (hookAny?.queueRecepciones?.rows ?? []) as QueueRowUI[];
  const recepMeta = hookAny?.queueRecepciones?.meta ?? emptyMeta;
  const recepLoading: boolean = !!hookAny?.isLoadingRecepciones;
  const onPageRecep = (n: number) => hookAny?.onPageChangeRecepciones?.(n);

  const invRows: QueueRowUI[] = (hookAny?.queueInventarios?.rows ?? []) as QueueRowUI[];
  const invMeta = hookAny?.queueInventarios?.meta ?? emptyMeta;
  const invLoading: boolean = !!hookAny?.isLoadingInventarios;
  const onPageInv = (n: number) => hookAny?.onPageChangeInventarios?.(n);

  const logRows: QueueRowUI[] = (hookAny?.queueLogistica?.rows ?? []) as QueueRowUI[];
  const logMeta = hookAny?.queueLogistica?.meta ?? emptyMeta;
  const logLoading: boolean = !!hookAny?.isLoadingLogistica;
  const onPageLog = (n: number) => hookAny?.onPageChangeLogistica?.(n);

  // Texto auxiliar para "Finalizar"
  const finishHint = useMemo(() => {
    const to = (weekState as any)?.active_week?.rango_inferido?.to as string | undefined;
    return to ? `Finaliza al completar 7 días (${to})` : "Finalizar semana";
  }, [weekState]);

  // ────────────────────────────────────────────────────────────────────────────
  // Render
  return (
    <Box
      p={2.5}
      component={motion.div}
      {...pageTransition}
      sx={{
        background: `linear-gradient(135deg, ${alpha(theme.palette.primary.main, 0.02)} 0%, ${alpha(
          theme.palette.background.default,
          0.8
        )} 100%)`,
        minHeight: "100vh",
      }}
    >
      {/* Shell único premium */}
      <Paper
        elevation={1}
        sx={{
          borderRadius: 4,
          overflow: "hidden",
          backgroundColor: "background.paper",
          border: `1px solid ${alpha(theme.palette.divider, 0.1)}`,
          boxShadow: "0 4px 24px rgba(0,0,0,0.06)",
        }}
      >
        {/* Header */}
        <Box
          sx={{
            background: `linear-gradient(135deg, ${alpha(theme.palette.primary.main, 0.03)} 0%, ${alpha(
              theme.palette.background.paper,
              1
            )} 100%)`,
            p: { xs: 2, md: 3 },
            borderBottom: `1px solid ${alpha(theme.palette.divider, 0.08)}`,
          }}
        >
          <Box
            display="grid"
            gap={2}
            sx={{ gridTemplateColumns: { xs: "1fr", md: "1fr auto" }, alignItems: "center" }}
          >
            <Box display="flex" alignItems="center" gap={2} flexWrap="wrap">
              <Box
                sx={{
                  width: 40,
                  height: 40,
                  borderRadius: 2,
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  background: `linear-gradient(135deg, ${theme.palette.primary.main} 0%, ${theme.palette.primary.dark} 100%)`,
                  boxShadow: `0 4px 12px ${alpha(theme.palette.primary.main, 0.3)}`,
                }}
              >
                <TrendingUpIcon sx={{ color: "white", fontSize: 22 }} />
              </Box>
              <Box>
                <Typography
                  variant="h4"
                  sx={{
                    fontWeight: 800,
                    letterSpacing: -0.5,
                    background: `linear-gradient(135deg, ${theme.palette.text.primary} 0%, ${alpha(
                      theme.palette.text.primary,
                      0.8
                    )} 100%)`,
                    backgroundClip: "text",
                    WebkitBackgroundClip: "text",
                    WebkitTextFillColor: "transparent",
                    lineHeight: 1.1,
                    mb: 0.5,
                  }}
                >
                  Tablero de Bodega
                </Typography>
                <Box display="flex" alignItems="center" gap={1.5}>
                  <Chip
                    label={temporadaChipLabel}
                    size="small"
                    color="primary"
                    variant="filled"
                    sx={{
                      fontWeight: 600,
                      backgroundColor: alpha(theme.palette.primary.main, 0.12),
                      color: theme.palette.primary.dark,
                    }}
                  />
                  {hasWeeks && (
                    <Chip
                      icon={<CalendarTodayIcon fontSize="small" />}
                      label={`Semana ${semanaIndex ?? "--"}`}
                      size="small"
                      variant="outlined"
                      sx={{
                        borderColor: alpha(theme.palette.primary.main, 0.3),
                        color: theme.palette.primary.dark,
                      }}
                    />
                  )}
                </Box>
              </Box>
            </Box>

            {bodegaId && bodegaId > 0 && (
              <Box display="flex" justifyContent={{ xs: "flex-start", md: "flex-end" }}>
                <QuickActions bodegaId={bodegaId} temporadaId={temporadaId} onNavigate={goto} dense pill />
              </Box>
            )}
          </Box>
        </Box>

        {/* Subheader sticky: WeekSwitcher + acciones */}
        <Box
          sx={{
            position: "sticky",
            top: 0,
            zIndex: (t) => t.zIndex.appBar - 1,
            px: { xs: 2, md: 3 },
            py: 2,
            backgroundColor: alpha(theme.palette.background.paper, 0.96),
            borderBottom: `1px solid ${alpha(theme.palette.divider, 0.1)}`,
            backdropFilter: "saturate(180%) blur(12px)",
            WebkitBackdropFilter: "saturate(180%) blur(12px)",
          }}
        >
          <Box
            display="flex"
            alignItems="center"
            gap={3}
            flexWrap="wrap"
            component={motion.div}
            variants={staggerChildren}
            initial="initial"
            animate="animate"
          >
            <Box component={motion.div} variants={sectionTransition}>
              <WeekSwitcher
                value={weekValue}
                onChange={handleWeekChange}
                disabled={disableSwitcher}
                disablePrev={disablePrev}
                disableNext={disableNext}
              />
            </Box>

            <Box display="flex" alignItems="center" gap={1.5} component={motion.div} variants={sectionTransition}>
              {hasWeeks && (
                <Typography
                  variant="body2"
                  color="text.secondary"
                  sx={{ fontWeight: 500, display: "flex", alignItems: "center", gap: 1 }}
                >
                  <CalendarTodayIcon fontSize="small" />
                  {rangoPretty || "—"}
                </Typography>
              )}

              {hasWeeks && (hasActiveOpenWeek ? (
                <Chip
                  label="Activa"
                  size="small"
                  sx={{
                    fontWeight: 700,
                    fontSize: "0.6875rem",
                    height: 24,
                    borderRadius: 1.5,
                    background: alpha(theme.palette.success.main, 0.12),
                    color: theme.palette.success.dark,
                    border: `1px solid ${alpha(theme.palette.success.main, 0.3)}`,
                    "& .MuiChip-label": { px: 1.5 },
                  }}
                />
              ) : (
                <Chip
                  label="Cerrada"
                  size="small"
                  sx={{
                    fontWeight: 700,
                    fontSize: "0.6875rem",
                    height: 24,
                    borderRadius: 1.5,
                    background: alpha(theme.palette.grey[500], 0.12),
                    color: theme.palette.text.secondary,
                    border: `1px solid ${alpha(theme.palette.divider, 0.3)}`,
                    "& .MuiChip-label": { px: 1.5 },
                  }}
                />
              ))}
            </Box>

            <Box flexGrow={1} />

            <Box display="flex" alignItems="center" gap={1} component={motion.div} variants={sectionTransition}>
              <Tooltip title={hasActiveOpenWeek ? "Ya existe una semana abierta" : "Iniciar semana"}>
                <span>
                  <Button
                    size="small"
                    variant="contained"
                    startIcon={busyStart ? <CircularProgress size={16} /> : <PlayArrowIcon />}
                    disabled={!bodegaId || busyStart || hasActiveOpenWeek}
                    onClick={handleStart}
                    sx={{
                      borderRadius: 3,
                      textTransform: "none",
                      fontWeight: 600,
                      px: 2,
                      boxShadow: "none",
                    }}
                  >
                    Iniciar
                  </Button>
                </span>
              </Tooltip>

              <Tooltip title={!hasActiveOpenWeek ? "No hay semana abierta para cerrar" : finishHint}>
                <span>
                  <Button
                    size="small"
                    variant="outlined"
                    startIcon={busyFinish ? <CircularProgress size={16} /> : <StopIcon />}
                    disabled={!bodegaId || busyFinish || !hasActiveOpenWeek || !canFinish}
                    onClick={handleFinish}
                    sx={{
                      borderRadius: 3,
                      textTransform: "none",
                      fontWeight: 600,
                      px: 2,
                      borderWidth: 2,
                      "&:hover": { borderWidth: 2 },
                    }}
                  >
                    Finalizar
                  </Button>
                </span>
              </Tooltip>

              <Tooltip title="Reporte (pendiente de implementación)">
                <span>
                  <Button
                    size="small"
                    variant="text"
                    startIcon={<AssessmentIcon />}
                    disabled
                    sx={{ borderRadius: 3, textTransform: "none", fontWeight: 600, px: 2 }}
                  >
                    Reporte
                  </Button>
                </span>
              </Tooltip>
            </Box>
          </Box>

          {/* Mensaje de error de acción */}
          {!!actionError && (
            <Box mt={1}>
              <Alert
                severity="error"
                onClose={() => setActionError(null)}
                sx={{
                  borderRadius: 2,
                  border: `1px solid ${alpha(theme.palette.error.main, 0.2)}`,
                  backgroundColor: alpha(theme.palette.error.main, 0.04),
                }}
              >
                {actionError}
              </Alert>
            </Box>
          )}
        </Box>

        {/* Cuerpo semanal con transiciones */}
        <Box sx={{ px: { xs: 2, md: 3 }, py: 1 }}>
          <AnimatePresence initial={false} mode="wait">
            <Box component={motion.div} key={isoSemana || weekValue.from} {...pageTransition}>
              {/* KPIs */}
              <Box sx={{ py: 3 }}>
                {errorSummary ? (
                  <Alert
                    severity="error"
                    sx={{
                      borderRadius: 3,
                      border: `1px solid ${alpha(theme.palette.error.main, 0.2)}`,
                      backgroundColor: alpha(theme.palette.error.main, 0.04),
                      mb: 2,
                    }}
                    action={
                      <Button color="inherit" size="small" onClick={() => refetchSummary()} sx={{ fontWeight: 600 }}>
                        Reintentar
                      </Button>
                    }
                  >
                    <AlertTitle sx={{ fontWeight: 700 }}>Error al cargar KPIs</AlertTitle>
                    {String((errorSummary as any)?.message ?? "Error desconocido")}
                  </Alert>
                ) : (
                  <KpiCards items={kpiCards} loading={isLoadingSummary} />
                )}
              </Box>

              <Divider sx={{ my: 3, borderColor: alpha(theme.palette.divider, 0.1), borderWidth: 1 }} />

              {/* Sección: Recepciones */}
              <Box sx={{ py: 3 }} component={motion.section} variants={sectionTransition} initial="initial" animate="animate">
                <SectionHeader
                  icon={<InventoryIcon sx={{ color: "primary.main", fontSize: 28 }} />}
                  title="Recepciones"
                  subtitle={hasWeeks ? `Semana ${semanaIndex ?? "—"}` : undefined}
                />
                <Paper variant="outlined" sx={{ p: { xs: 1.5, md: 2 }, borderRadius: 3 }}>
                  <ResumenRecepciones
                    rows={recepRows}
                    meta={recepMeta}
                    loading={recepLoading}
                    onPageChange={onPageRecep}
                  />
                </Paper>
              </Box>

              <Divider sx={{ my: 3, borderColor: alpha(theme.palette.divider, 0.1), borderWidth: 1 }} />

              {/* Sección: Inventarios */}
              <Box sx={{ py: 3 }} component={motion.section} variants={sectionTransition} initial="initial" animate="animate">
                <SectionHeader
                  icon={<WarehouseIcon sx={{ color: "primary.main", fontSize: 28 }} />}
                  title="Inventarios"
                  subtitle={hasWeeks ? `Semana ${semanaIndex ?? "—"}` : undefined}
                />
                <Paper variant="outlined" sx={{ p: { xs: 1.5, md: 2 }, borderRadius: 3 }}>
                  <ResumenInventarios rows={invRows} meta={invMeta} loading={invLoading} onPageChange={onPageInv} />
                </Paper>
              </Box>

              <Divider sx={{ my: 3, borderColor: alpha(theme.palette.divider, 0.1), borderWidth: 1 }} />

              {/* Sección: Logística */}
              <Box sx={{ py: 3 }} component={motion.section} variants={sectionTransition} initial="initial" animate="animate">
                <SectionHeader
                  icon={<LocalShippingIcon sx={{ color: "primary.main", fontSize: 28 }} />}
                  title="Despachos / Logística"
                  subtitle={hasWeeks ? `Semana ${semanaIndex ?? "—"}` : undefined}
                />
                <Paper variant="outlined" sx={{ p: { xs: 1.5, md: 2 }, borderRadius: 3 }}>
                  <ResumenLogistica rows={logRows} meta={logMeta} loading={logLoading} onPageChange={onPageLog} />
                </Paper>
              </Box>
            </Box>
          </AnimatePresence>
        </Box>
      </Paper>
    </Box>
  );
};

// Header compacto reutilizable para cada bloque
const SectionHeader: React.FC<{ icon: React.ReactNode; title: string; subtitle?: string }> = ({
  icon,
  title,
  subtitle,
}) => {
  const theme = useTheme();
  return (
    <Box display="flex" alignItems="center" justifyContent="space-between" mb={2.5}>
      <Box display="flex" alignItems="center" gap={1.5}>
        {icon}
        <Box>
          <Typography variant="h6" sx={{ fontWeight: 700, color: theme.palette.text.primary }}>
            {title}
          </Typography>
          {subtitle && (
            <Typography variant="body2" color="text.secondary" sx={{ fontWeight: 500 }}>
              {subtitle}
            </Typography>
          )}
        </Box>
      </Box>
      <Tooltip title="Refrescar bloque (cuando se conecte al servicio)">
        <IconButton
          size="medium"
          disabled
          sx={{
            border: `1px solid ${alpha(theme.palette.divider, 0.3)}`,
            borderRadius: 2,
            "&:hover": { backgroundColor: alpha(theme.palette.primary.main, 0.05) },
          }}
        >
          <RefreshIcon fontSize="small" />
        </IconButton>
      </Tooltip>
    </Box>
  );
};

export default TableroBodegaPage;

